name: Create GitHub Release

on:
  workflow_run:
    workflows: ["Auto Tag Version"]
    types:
      - completed

permissions:
  contents: write

jobs:
  wait-and-release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Get commit messages since last tag
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            echo "Getting commits since $PREVIOUS_TAG"
            COMMITS=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --reverse)
          fi

          # Write to file to preserve newlines
          echo "$COMMITS" > changelog.txt
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Install dependencies
        run: npx expo install react-native-web

      - name: Wait for EAS build to complete
        id: wait-build
        run: |
          echo "Waiting for EAS build triggered by tag ${{ steps.version.outputs.tag }}"
          echo "Expo should automatically start a build when it sees the tag..."

          # Smart polling strategy to avoid rate limits:
          # - Initial delay: 5 min (builds typically take 7-15 min minimum)
          # - First checks (5-15 min): every 2 min (catch fast builds)
          # - Mid checks (15-30 min): every 3 min (most builds finish here)
          # - Late checks (30-60 min): every 5 min (for slow builds)
          # Total: ~20 API calls over 60 minutes instead of 36+

          echo "â³ Initial delay: Waiting 5 minutes before first check (builds typically take 7-15 min)..."
          sleep 300
          ELAPSED_TIME=300

          ATTEMPT=0

          while true; do
            ATTEMPT=$((ATTEMPT + 1))

            # Determine sleep interval based on elapsed time
            if [ $ELAPSED_TIME -lt 900 ]; then
              # 5-15 minutes: check every 2 minutes
              SLEEP_INTERVAL=120
              PHASE="early (2min intervals)"
            elif [ $ELAPSED_TIME -lt 1800 ]; then
              # 15-30 minutes: check every 3 minutes
              SLEEP_INTERVAL=180
              PHASE="mid (3min intervals)"
            elif [ $ELAPSED_TIME -lt 3600 ]; then
              # 30-60 minutes: check every 5 minutes
              SLEEP_INTERVAL=300
              PHASE="late (5min intervals)"
            else
              # Timeout after 60 minutes
              echo "â±ï¸ Timeout: Build did not complete within 60 minutes"
              echo "Check Expo dashboard: https://expo.dev"
              exit 1
            fi

            echo "â³ Checking for build (attempt $ATTEMPT, ${ELAPSED_TIME}s elapsed, $PHASE)..."

            # List recent builds and pick one matching this workflow's commit SHA.
            BUILD_LIST=$(eas build:list --platform=android --limit=5 --json 2>/dev/null || echo "[]")

            MATCHED_BUILD=$(echo "$BUILD_LIST" | jq -c --arg sha "$GITHUB_SHA" '[.[] | select((.gitCommitSha // .commit // .gitCommitHash // "") == $sha)] | .[0] // empty' 2>/dev/null || echo "")
            if [ -n "$MATCHED_BUILD" ]; then
              BUILD_SOURCE="sha-match"
              SELECTED_BUILD="$MATCHED_BUILD"
            else
              FALLBACK_BUILD=$(echo "$BUILD_LIST" | jq -c '.[0] // empty' 2>/dev/null || echo "")
              if [ -n "$FALLBACK_BUILD" ]; then
                BUILD_SOURCE="latest"
                SELECTED_BUILD="$FALLBACK_BUILD"
              else
                BUILD_SOURCE="none"
                SELECTED_BUILD=""
              fi
            fi

            BUILD_STATUS=$(echo "$SELECTED_BUILD" | jq -r '.status // "unknown"' 2>/dev/null || echo "unknown")
            BUILD_ID=$(echo "$SELECTED_BUILD" | jq -r '.id // ""' 2>/dev/null || echo "")
            ARTIFACT_URL=$(echo "$SELECTED_BUILD" | jq -r '.artifacts.buildUrl // ""' 2>/dev/null || echo "")

            if [ "$BUILD_SOURCE" = "none" ]; then
              echo "âš ï¸ No builds returned by EAS yet; waiting..."
            else
              echo "Selected build ($BUILD_SOURCE): ID=$BUILD_ID, Status=$BUILD_STATUS"
            fi

            if [ "$BUILD_STATUS" = "FINISHED" ]; then
              echo "âœ… Build completed successfully after ${ELAPSED_TIME}s!"
              echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

              # Get APK download URL
              APK_URL=$(echo "$SELECTED_BUILD" | jq -r '.artifacts.applicationArchiveUrl // ""' 2>/dev/null || echo "")
              echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
              break
            elif [ "$BUILD_STATUS" = "ERRORED" ] || [ "$BUILD_STATUS" = "CANCELED" ]; then
              echo "âŒ Build failed or was canceled (Status: $BUILD_STATUS)"
              echo "Check the build logs at: https://expo.dev/accounts/$(eas whoami)/projects/crewsplit/builds/$BUILD_ID"
              exit 1
            elif [ "$BUILD_STATUS" = "IN_PROGRESS" ] || [ "$BUILD_STATUS" = "IN_QUEUE" ]; then
              echo "ðŸ”¨ Build is $BUILD_STATUS..."
            else
              echo "ðŸ” No build found yet, waiting for Expo to trigger..."
            fi

            echo "Sleeping for ${SLEEP_INTERVAL}s..."
            sleep $SLEEP_INTERVAL
            ELAPSED_TIME=$((ELAPSED_TIME + SLEEP_INTERVAL))
          done
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Download APK
        id: download
        run: |
          APK_URL="${{ steps.wait-build.outputs.apk_url }}"

          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            echo "âŒ No APK URL found in build artifacts"
            exit 1
          fi

          echo "ðŸ“¦ Downloading APK from: $APK_URL"
          APK_FILE="CrewSplit-v${{ steps.version.outputs.version }}.apk"
          curl -L --fail --show-error -o "$APK_FILE" "$APK_URL"

          # Verify file exists and has size > 0
          if [ ! -f "$APK_FILE" ] || [ ! -s "$APK_FILE" ]; then
            echo "âŒ Failed to download APK or file is empty"
            exit 1
          fi

          FILE_SIZE=$(stat -c%s "$APK_FILE" 2>/dev/null || stat -f%z "$APK_FILE" 2>/dev/null || echo "0")
          echo "âœ… Downloaded APK: $APK_FILE ($FILE_SIZE bytes)"
          echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT

      - name: Prepare release notes
        run: |
          {
            echo "## CrewSplit v${{ steps.version.outputs.version }}"
            echo ""
            echo "### Changes in this release"
            echo ""
            cat changelog.txt
            echo ""
            echo "### Installation"
            echo ""
            echo "1. Download the APK file from the **Assets** section below"
            echo "2. Install it on your Android device"
            echo "3. You may need to enable \"Install from Unknown Sources\" in your device settings"
            echo ""
            echo "### Build Info"
            echo ""
            echo "- Built with EAS Build (Build ID: ${{ steps.wait-build.outputs.build_id }})"
            echo "- Platform: Android"
          } > release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: CrewSplit ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            ${{ steps.download.outputs.apk_file }}
          body_path: release-notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
